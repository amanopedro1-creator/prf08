<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Painel Interno - PRF Jaguar&eacute;</title>
    <link rel="icon" type="image/x-icon" href="assets/img/prflogoico.ico">
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }
            } catch (e) {}
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        window.SUPABASE_URL = 'https://pssujmmuachdymlwsiuj.supabase.co';
        window.SUPABASE_ANON_KEY = 'sb_publishable_PYQxZQr_TfVEesG7L4WI4g_-VjPHVpW';

        (async function enforceAuth() {
            try {
                if (!window.supabase || !window.supabase.createClient) {
                    window.location.replace('../login.html');
                    return;
                }
                const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                const result = await client.auth.getSession();
                const session = result && result.data ? result.data.session : null;
                const user = session ? session.user : null;
                if (!user) {
                    window.location.replace('../login.html');
                    return;
                }

                const profileQuery = await client
                    .from('profiles')
                    .select('aprovado')
                    .eq('id', user.id)
                    .maybeSingle();
                const profile = profileQuery ? profileQuery.data : null;
                const profileError = profileQuery ? profileQuery.error : null;

                if (profileError || !profile || profile.aprovado !== true) {
                    await client.auth.signOut();
                    window.location.replace('../login.html');
                    return;
                }
            } catch (e) {
                window.location.replace('../login.html');
            }
        })();
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="top-header">
        <div class="container">
            <div class="top-header-content">
                <div class="logo-governo">
                    <a href="painel.html" class="gov-logo-link">
                        <img src="assets/img/gov_br.png" alt="Governo do Brasil" class="gov-logo">
                    </a>
                    <span class="gov-divider" aria-hidden="true"></span>
                    <div class="gov-identity">
                        <span class="gov-ministry">MINISTÉRIO DA JUSTIÇA E SEGURANÇA PÚBLICA</span>
                        <span class="gov-agency">Polícia Rodoviária Federal</span>
                    </div>
                </div>
                <div class="top-header-right">
                    <div class="user-auth-header">
                        <a href="../login.html" id="header-login-btn" class="auth-link">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>LOGIN</span>
                        </a>
                        <a href="../criar-conta.html" id="header-register-btn" class="auth-link">
                            <i class="fas fa-user-plus"></i>
                            <span>CRIAR CONTA</span>
                        </a>
                        <div id="header-user-menu" class="user-menu-header is-hidden">
                            <span class="user-name-header"></span>
<a href="painel.html#meu-perfil" class="auth-link" id="header-edit-profile-link">
                                <i class="fas fa-user-edit"></i>
                                <span>EDITAR PERFIL</span>
                            </a>
                            <a href="#" onclick="auth.logout(); return false;" class="auth-link">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>SAIR</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

        <header class="main-header main-header--duna" id="menu">
        <div class="container">
            <div class="header-row">

            <!-- ESQUERDA: 3 pÃ¡ginas -->
            <nav class="mini-nav mini-nav--left" aria-label="PÃ¡ginas (esquerda)">
                <a href="../index.html">INÍCIO</a>
                    <div class="nav-dropdown">
                        <a href="#" class="nav-link-dropdown" aria-haspopup="true" aria-expanded="false">INSTITUCIONAL</a>
                        <div class="dropdown-menu">
                            <a href="../organograma.html">Organograma</a>
<a href="../historia-valores.html">História e Valores</a>
                        </div>
                    </div>
                    <div class="nav-dropdown">
                        <a href="#" class="nav-link-dropdown" aria-haspopup="true" aria-expanded="false">SERVIÇOS</a>
                            <div class="dropdown-menu">
                            <a href="../documentos.html">Documentos PRF</a>
                        </div>
                    </div>
            </nav>

            <!-- CENTRO: informaÃ§Ã£o (logo + textos) -->
            <div class="main-header-top">
                <div class="brand-block">
                <a href="../index.html" class="brand-logo-link">
                <img src="assets/img/prf.png" alt="PRF JaguarÃ©" class="brand-logo">
                </a>
                </div>
            </div>
            <!-- DIREITA: +3 pÃ¡ginas -->
            <nav class="mini-nav mini-nav--right" aria-label="PÃ¡ginas (direita)">
                <a href="../concursos.html">CONCURSOS</a>
                <a href="../capacitacao.html">CAPACITAÇÃO E TREINAMENTO</a>
                <a href="../corregedoria.html">CORREGEDORIA</a>
            </nav>
            </div>
            <div class="red-line"></div>
        </div>
        </header>

    <section class="latest-news info-section">
        <div class="container">
            <div class="news-header">
                <h2>SIGA - Sistema Integrado de Gestão Administrativa</h2>
                <div class="red-line-news"></div>
            </div>
            <article class="profile-brand-card" id="painel-profile-card">
                <div class="profile-brand-overlay">
                    <div class="profile-brand-main">
                        <div class="profile-brand-identity">
                            <div class="profile-brand-photo-col">
                                <div class="profile-brand-photo-wrap">
                                    <img id="painel-profile-photo" class="profile-brand-photo" src="assets/img/prf.png" alt="Foto do usuário">
                                </div>
                                <div id="painel-profile-medals" class="profile-brand-medals is-hidden" aria-label="Condecorações do usuário"></div>
                                <a href="painel.html#meu-perfil" class="profile-brand-edit-link">Editar perfil</a>
                            </div>
                            <div class="profile-brand-text">
                                <div class="profile-brand-name" id="painel-profile-name">Usuário</div>
                                <div class="profile-brand-role-line">
                                    <img id="painel-profile-cargo-img" class="profile-role-img is-hidden" alt="Imagem do cargo">
                                    <div class="profile-brand-role" id="painel-profile-cargo">Cargo do agente</div>
                                </div>
                                <div class="profile-brand-rg" id="painel-profile-rg">RG: -</div>
                                <div class="profile-shift-wrap">
                                    <button type="button" id="painel-shift-btn" class="profile-shift-btn profile-shift-btn--idle">
                                        Entrar em serviço
                                    </button>
                                </div>
                            </div>
                        </div>

                        <aside class="profile-brand-meta">
                            <div class="profile-brand-meta-item">
                                <span>Grupamento</span>
                                <strong id="painel-profile-grupamento">-</strong>
                            </div>
                            <div class="profile-brand-meta-item">
                                <span>Cursos</span>
                                <div id="painel-profile-cursos" class="profile-course-list">
                                    <span class="profile-course-empty">A definir</span>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </article>
            <div class="painel-aviso-top">
                <article id="painel-latest-aviso" class="painel-latest-aviso" aria-live="polite">
                    <h3>Mural de Avisos</h3>
                    <p class="painel-latest-aviso-empty">Carregando aviso...</p>
                </article>
            </div>
            <div class="painel-layout">
                <aside class="painel-side-menu" aria-label="Navegação interna rápida">
                    <a href="#" class="painel-side-link" id="painel-notificacoes-toggle" rel="noopener">
                        <i class="fas fa-bell" aria-hidden="true"></i>
                        <span>Notificações</span>
                        <strong id="painel-notificacoes-badge" class="painel-side-badge is-hidden">0</strong>
                    </a>
                    <a href="#" class="painel-side-link" id="painel-profile-trigger">
                        <i class="fas fa-id-card" aria-hidden="true"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <a href="/interno/diario-oficial.html" class="painel-side-link" rel="noopener">
                        <i class="fas fa-newspaper" aria-hidden="true"></i>
                        <span>Di&aacute;rio Oficial</span>
                    </a>
                    <a href="https://docs.google.com/document/d/15VyNPcd7FLcnPPAgikZe_VPWCk1li0S0aE47i_EXH90/edit?usp=sharing" class="painel-side-link" id="painel-regulamento-trigger" rel="noopener">
                        <i class="fas fa-gavel" aria-hidden="true"></i>
                        <span>Regulamento Disciplinar</span>
                    </a>
                    <a href="https://docs.google.com/spreadsheets/d/1ysSkZjzHLhCYbEYdWCY8BPKnfQ6NvZs1Bu-TthDqgrk/edit?usp=sharing" class="painel-side-link" id="painel-ctb-trigger" rel="noopener">
                        <i class="fas fa-road" aria-hidden="true"></i>
                        <span>C&oacute;digo de Tr&acirc;nsito Brasileiro</span>
                    </a>
                    <a href="https://docs.google.com/document/d/1i4M0SuHjl3hygdDxjdrNIes3jMYzx67hYyB7ZC3XwJk/edit?usp=sharing" class="painel-side-link" id="painel-uniformes-trigger" rel="noopener">
                        <i class="fas fa-shirt" aria-hidden="true"></i>
                        <span>Padrão de Uniformes</span>
                    </a>
                    <a href="#" class="painel-side-link" id="painel-mapa-trigger">
                        <i class="fas fa-map-location-dot" aria-hidden="true"></i>
                        <span>Mapa Interativo</span>
                    </a>
                    <a href="/interno/avisos.html" class="painel-side-link" rel="noopener">
                        <i class="fas fa-bullhorn" aria-hidden="true"></i>
                        <span>Painel de Avisos</span>
                    </a>
                    <a href="/interno/equipe.html" class="painel-side-link" rel="noopener">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        <span>Equipe</span>
                    </a>
                    <a href="/interno/concursos-internos.html" class="painel-side-link" rel="noopener">
                        <i class="fas fa-bullhorn" aria-hidden="true"></i>
                        <span>Concursos Internos</span>
                    </a>
                </aside>
                <div class="painel-main-content">
                    <div class="painel-main-grid">
                        <div class="painel-main-left">
                            <div id="painel-main-default">
                        <div class="docs-grid" id="painel-main-docs-grid">
                    <a href="/interno/bou.html" class="docs-card" rel="noopener">
                        <i class="fas fa-handcuffs docs-card-icon" aria-hidden="true"></i>
                        <span>BOU - Boletim de Ocorrência Unificado</span>
                    </a>
                    <a href="/interno/ait.html" class="docs-card" rel="noopener">
                        <i class="fas fa-file-invoice-dollar docs-card-icon" aria-hidden="true"></i>
                        <span>AIT - Auto de Infração de Trânsito</span>
                    </a>
                    <a href="/interno/patrulha.html" class="docs-card" rel="noopener">
                        <i class="fas fa-route docs-card-icon" aria-hidden="true"></i>
                        <span>RIPAT - Relatório Integrado de Patrulha</span>
                    </a>
                    <a href="/interno/relatorio-aluno.html" class="docs-card" id="relatorio-aluno-card" rel="noopener">
                        <i class="fas fa-user-graduate docs-card-icon" aria-hidden="true"></i>
                        <span>ACE - Avaliação de Capacitação e Ensino</span>
                    </a>

                    <a href="/interno/bou-envios.html" class="docs-card" rel="noopener">
                        <i class="fas fa-paper-plane docs-card-icon" aria-hidden="true"></i>
                        <span>BOU Enviados</span>
                    </a>
                    <a href="/interno/ait-preenchidos.html" class="docs-card" id="ait-preenchidos-card" rel="noopener">
                        <i class="fas fa-file-circle-check docs-card-icon" aria-hidden="true"></i>
                        <span>AIT Preenchidos</span>
                    </a>
                    <a href="/interno/ripat-publicados.html" class="docs-card" id="ripat-publicados-card" rel="noopener">
                        <i class="fas fa-folder-open docs-card-icon" aria-hidden="true"></i>
                        <span>RIPAT Publicados</span>
                    </a>
                    <a href="/interno/ace-resultados.html" class="docs-card" id="ace-resultados-card" rel="noopener">
                        <i class="fas fa-list-check docs-card-icon" aria-hidden="true"></i>
                        <span>ACE Resultados</span>
                    </a>

                    <a href="/interno/relatorio-voo.html" class="docs-card" id="relatorio-voo-card" rel="noopener">
                        <i class="fas fa-helicopter docs-card-icon" aria-hidden="true"></i>
                        <span>RAVOP - Relatório de Aeronavegação Operacional</span>
                    </a>
                    <a href="/interno/corregedoria.html" class="docs-card" rel="noopener">
                        <i class="fas fa-scale-balanced docs-card-icon" aria-hidden="true"></i>
                        <span>Corregedoria</span>
                    </a>
                    <a href="/interno/gerenciamento-equipe.html" class="docs-card" rel="noopener">
                        <i class="fas fa-users-gear docs-card-icon" aria-hidden="true"></i>
                        <span>Gerenciamento de Equipe</span>
                    </a>
                    <a href="/interno/aprovacoes.html" class="docs-card" id="painel-dgp-card" rel="noopener">
                        <i class="fas fa-user-shield docs-card-icon" aria-hidden="true"></i>
                        <span>Painel DGP</span>
                    </a>                    
                </div>
                        </div>
                        <section id="painel-docs-inline" class="painel-docs-inline is-hidden" aria-hidden="true">
                    <button type="button" id="painel-docs-inline-close" class="painel-docs-inline-close" aria-label="Fechar documentos">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                    <article id="painel-docs-inline-aviso" class="painel-latest-aviso">
                        <h3>Mural de avisos</h3>
                        <p class="painel-latest-aviso-empty">Carregando aviso...</p>
                    </article>
                            <article id="painel-profile-popup" class="painel-profile-popup is-hidden" aria-live="polite">
                        <div class="profile-popup-layout">
                            <div class="profile-popup-card">
                                <div class="profile-popup-logo profile-popup-logo--header">
                                    <img src="assets/img/prf.png" alt="Logo PRF">
                                </div>
                                <div class="profile-popup-card-header">
                                    <img src="assets/img/prf.png" alt="Foto do usuário" id="profile-popup-photo">
                                    <div class="profile-popup-card-text">
                                        <div class="profile-popup-name" id="profile-popup-name">Usuário</div>
                                        <div class="profile-popup-role-line">
                                            <div class="profile-popup-role" id="profile-popup-cargo">Cargo</div>
                                            <img id="profile-popup-cargo-img" class="profile-popup-role-img is-hidden" alt="Imagem do cargo">
                                        </div>
                                        <div class="profile-popup-rg" id="profile-popup-rg">RG: -</div>
                                    </div>
                                    <button type="button" id="profile-popup-edit-trigger" class="profile-popup-edit-trigger">
                                        <i class="fas fa-pen"></i>
                                        <span>Editar Perfil</span>
                                    </button>
                                </div>
                                <div id="profile-popup-edit-panel" class="profile-popup-edit-panel is-collapsed">
                                    <div class="profile-popup-edit-row">
                                        <label for="profile-popup-edit-nome">Nome</label>
                                        <input id="profile-popup-edit-nome" type="text">
                                    </div>
                                    <div class="profile-popup-edit-row">
                                        <label for="profile-popup-edit-rg">RG</label>
                                        <input id="profile-popup-edit-rg" type="text">
                                    </div>
                                    <div class="profile-popup-edit-row">
                                        <button type="button" id="profile-popup-edit-photo" class="profile-popup-edit-photo-btn">
                                            <i class="fas fa-camera"></i>
                                            <span>Alterar foto</span>
                                        </button>
                                        <input id="profile-popup-edit-file" type="file" accept="image/*" class="auth-photo-file-input">
                                    </div>
                                    <div class="profile-popup-edit-actions">
                                        <button type="button" id="profile-popup-save" class="bou-btn bou-btn-primary">Salvar</button>
                                    </div>
                                    <p id="profile-popup-edit-feedback" class="approvals-status"></p>
                                </div>
                            </div>
                            <div class="profile-popup-right">
                                <div class="profile-popup-metrics">
                                    <div class="profile-popup-metric">
                                        <span>Ocorrências</span>
                                        <strong id="profile-popup-bou-total">0</strong>
                                    </div>
                                    <div class="profile-popup-metric">
                                        <span>Multas</span>
                                        <strong id="profile-popup-ait-total">0</strong>
                                    </div>
                                    <div class="profile-popup-metric">
                                        <span>Serviços (RIPAT)</span>
                                        <strong id="profile-popup-ripat-total">0</strong>
                                    </div>
                                </div>
                                <div class="profile-popup-sections">
                                    <section class="profile-popup-section">
                                        <h4>Grupamentos</h4>
                                        <div id="profile-popup-grupos" class="profile-popup-chips">
                                            <span class="profile-course-empty">A definir</span>
                                        </div>
                                    </section>
                                    <section class="profile-popup-section">
                                        <h4>Cursos e Especializações</h4>
                                        <div id="profile-popup-cursos" class="profile-popup-chips">
                                            <span class="profile-course-empty">A definir</span>
                                        </div>
                                    </section>
                                    <section class="profile-popup-section profile-popup-section--wide">
                                        <h4>Condecorações e Medalhas</h4>
                                        <div id="profile-popup-medals" class="profile-popup-medals">
                                            <div class="profile-popup-empty">Nenhuma condecoração atribuída.</div>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </div>
                    </article>
                    <div id="painel-docs-map" class="painel-docs-map-wrap is-hidden">
                        <div class="mapa-interativo-layout is-vertical">
                            <article class="info-card mapa-interativo-panel">
                                <div class="mapa-interativo-header">
                                    <h3>Registrar ponto</h3>
                                    <p class="mapa-interativo-note">Clique no mapa para preencher X/Y automaticamente.</p>
                                    <p id="mapa-admin-warning" class="bou-status is-hidden">Somente administradores podem adicionar, editar ou excluir pontos.</p>
                                </div>
                                <form id="mapa-form" class="mapa-form">
                                    <label class="modal-form-group">
                                        <span>Cor do marcador</span>
                                        <input type="color" id="mapa-cor" value="#0ea5e9">
                                    </label>
                                    <label class="modal-form-group">
                                        <span>Título</span>
                                        <input type="text" id="mapa-titulo" placeholder="Identificador do ponto" required>
                                    </label>
                                    <label class="modal-form-group">
                                        <span>Descrição (opcional)</span>
                                        <textarea id="mapa-descricao" rows="3" placeholder="Detalhes adicionais"></textarea>
                                    </label>
                                    <div class="mapa-categorias-dinamicas">
                                        <label class="modal-form-group">
                                            <span>Categoria</span>
                                            <select id="mapa-categoria">
                                                <option value="">Selecione</option>
                                                <option value="Denúncia realizadas">Denúncia realizadas</option>
                                                <option value="Roubo de veículo">Roubo de veículo</option>
                                                <option value="Tráfico">Tráfico</option>
                                                <option value="Disparos">Disparos</option>
                                                <option value="Outros">Outros</option>
                                            </select>
                                        </label>
                                        <label class="modal-form-group">
                                            <span>Quantidade</span>
                                            <input type="number" id="mapa-quantidade" min="1" step="1" value="1">
                                        </label>
                                        <button type="button" id="mapa-add-categoria" class="approvals-btn">Adicionar categoria</button>
                                        <div id="mapa-categorias-lista" class="mapa-categorias-lista"></div>
                                    </div>
                                    <div class="mapa-form-row">
                                        <label class="modal-form-group">
                                            <span>X</span>
                                            <input type="number" id="mapa-x" step="0.01" placeholder="0" required>
                                        </label>
                                        <label class="modal-form-group">
                                            <span>Y</span>
                                            <input type="number" id="mapa-y" step="0.01" placeholder="0" required>
                                        </label>
                                    </div>
                                    <div class="mapa-form-actions">
                                        <button type="submit" id="mapa-submit" class="approvals-btn success">Publicar ponto</button>
                                        <button type="button" id="mapa-cancel" class="approvals-btn is-hidden">Cancelar</button>
                                    </div>
                                </form>
                                <div class="mapa-filters">
                                    <h4>Filtros</h4>
                                    <div class="mapa-filter-list">
                                        <label><input type="checkbox" class="mapa-filter" value="Denúncia realizadas" checked> Denúncia realizadas</label>
                                        <label><input type="checkbox" class="mapa-filter" value="Roubo de veículo" checked> Roubo de veículo</label>
                                        <label><input type="checkbox" class="mapa-filter" value="Tráfico" checked> Tráfico</label>
                                        <label><input type="checkbox" class="mapa-filter" value="Disparos" checked> Disparos</label>
                                        <label><input type="checkbox" class="mapa-filter" value="Outros" checked> Outros</label>
                                    </div>
                                    <input type="text" id="mapa-search" class="equipe-search" placeholder="Buscar por título ou descrição">
                                </div>
                            </article>

                            <article class="info-card mapa-interativo-map-wrap">
                                <div class="mapa-setores mapa-setores--top">
                                    <h4>Setores</h4>
                                    <div class="mapa-setores-list">
                                        <label><input type="checkbox" class="mapa-setor" value="0"> Setor 0</label>
                                        <label><input type="checkbox" class="mapa-setor" value="1"> Setor 1</label>
                                        <label><input type="checkbox" class="mapa-setor" value="2"> Setor 2</label>
                                    </div>
                                    <button type="button" id="mapa-setores-clear" class="approvals-btn">Limpar seleção</button>
                                </div>
                                <div id="mapa-interativo" class="mapa-interativo-canvas" aria-label="Mapa interativo"></div>
                                <p id="mapa-status" class="bou-status">Carregando mapa...</p>
                            </article>
                        </div>
                    </div>
                    <article class="info-card painel-docs-frame-wrap">
                        <h3 id="painel-docs-inline-title">Documento Interno</h3>
                        <iframe
                            id="painel-docs-inline-frame"
                            src=""
                            title="Documento Interno"
                            width="100%"
                            height="1200"
                            frameborder="0"
                            marginheight="0"
                            marginwidth="0"
                            style="border: 0; border-radius: 12px; background: #fff;"
                            loading="lazy">
                            Carregando...
                        </iframe>
                            </article>
                        </section>
                    </div>
                    <aside class="painel-on-duty" aria-live="polite">
                        <div class="painel-on-duty-header">
                            <h3>Em serviço</h3>
                            <span id="painel-on-duty-count">0</span>
                        </div>
                        <div id="painel-on-duty-list" class="painel-on-duty-list">
                            <p class="painel-on-duty-empty">Carregando agentes...</p>
                        </div>
                    </aside>
                </div>
                </div>
            </div>
        </div>
    </section>

    <aside id="painel-notificacoes-popup" class="painel-notificacoes-popup is-hidden" aria-live="polite">
        <button type="button" id="painel-notificacoes-mini" class="painel-notificacoes-mini" aria-label="Abrir notificações">
            <i class="fas fa-bell" aria-hidden="true"></i>
            <span id="painel-notificacoes-mini-badge" class="painel-notificacoes-mini-badge">0</span>
        </button>
        <div class="painel-notificacoes-head">
            <h3>Notificações</h3>
            <div class="painel-notificacoes-head-actions">
                <button type="button" id="painel-notificacoes-clear-all" class="painel-notificacoes-clear-all">
                    Apagar todas
                </button>
                <button type="button" id="painel-notificacoes-close" class="painel-notificacoes-close" aria-label="Fechar notificações">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        <p class="painel-notificacoes-sub">Cita&ccedil;&otilde;es em BOU, AIT, patrulha, relat&oacute;rio aluno, Di&aacute;rio Oficial e Corregedoria.</p>
        <div id="painel-notificacoes-list" class="painel-notificacoes-list">
            <p class="painel-notificacoes-empty">Carregando notificações...</p>
        </div>
    </aside>
    <footer class="diario-footer">
        <div class="container">
            <div class="diario-footer-top">
                <div class="diario-footer-brand">
                    <img src="assets/img/prf.png" alt="Polícia Rodoviária Federal" class="diario-footer-logo">
                    <div class="diario-footer-brand-text">
                        <strong>Polícia Rodoviária Federal</strong>
                        <span>Unidade Operacional Jaguaré</span>
                        <span>São Paulo - SP</span>
                    </div>
                </div>
                <div class="diario-footer-contact">
                    <h4>CONTATO</h4>
                    <p>PRF — Delegacia de Jaguaré</p>
                    <p>Telefone: 191 (PRF)</p>
                    <p>Emergência: 190</p>
                </div>
            </div>
            <div class="diario-footer-divider" aria-hidden="true"></div>
            <div class="diario-footer-bottom">
                <span>© 2026 Polícia Rodoviária Federal — Todos os direitos reservados</span>
                <img src="assets/img/gov_br.png" alt="gov.br" class="diario-footer-gov">
            </div>
        </div>
    </footer>

    <script src="app.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script src="mapa-interativo.js" defer></script>
    <script>
        (function setupPainelDocsPopup() {
            function byId(id) { return document.getElementById(id); }
            const panel = byId('painel-docs-inline');
            const closeBtn = byId('painel-docs-inline-close');
            const openReg = byId('painel-regulamento-trigger');
            const openCtb = byId('painel-ctb-trigger');
            const openUni = byId('painel-uniformes-trigger');
            const openProfile = byId('painel-profile-trigger');
            const openMap = byId('painel-mapa-trigger');
            const headerEditProfile = byId('header-edit-profile-link');
            const brandEditProfile = document.querySelector('.profile-brand-edit-link');
            const avisoSource = byId('painel-latest-aviso');
            const avisoTarget = byId('painel-docs-inline-aviso');
            const mainDefault = byId('painel-main-default');
            const mainContent = document.querySelector('.painel-main-content');
            const frame = byId('painel-docs-inline-frame');
            const frameWrap = frame ? frame.closest('.painel-docs-frame-wrap') : null;
            const mapWrap = byId('painel-docs-map');
            const profileWrap = byId('painel-profile-popup');
            const title = byId('painel-docs-inline-title');
            if (!panel || !openReg || !openUni || !mainDefault) return;
            let activeTrigger = null;
            let editClient = null;
            let editUser = null;
            let editProfile = null;
            let pendingPhotoFile = null;
            let currentFotoPath = '';
            let editBound = false;
            const docTriggers = [openReg, openCtb, openUni, openProfile, openMap];

            const setActiveTriggerVisual = function (node) {
                docTriggers.forEach(function (lnk) {
                    if (!lnk) return;
                    lnk.classList.remove('is-open-link');
                    lnk.style.background = '';
                    lnk.style.color = '';
                    lnk.style.borderColor = '';
                    lnk.removeAttribute('aria-current');
                    const icon = lnk.querySelector('i');
                    const label = lnk.querySelector('span');
                    if (icon) icon.style.color = '';
                    if (label) label.style.color = '';
                });
                if (!node) return;
                node.classList.add('is-open-link');
                node.style.background = '#1d4ed8';
                node.style.color = '#ffffff';
                node.style.borderColor = '#1d4ed8';
                node.setAttribute('aria-current', 'page');
                const icon = node.querySelector('i');
                const label = node.querySelector('span');
                if (icon) icon.style.color = '#ffffff';
                if (label) label.style.color = '#ffffff';
            };

            const syncAviso = function () {
                if (!avisoSource || !avisoTarget) return;
                avisoTarget.innerHTML = avisoSource.innerHTML;
            };

            const setDocInFrame = function (href, label, useMap, useProfile) {
                if (title) title.textContent = label || (useProfile ? 'Meu Perfil' : (useMap ? 'Mapa Interativo' : 'Documento Interno'));
                if (mainContent) mainContent.classList.toggle('is-profile-open', !!useProfile);
                if (useProfile) {
                    if (frame) frame.src = '';
                    if (frameWrap) frameWrap.classList.add('is-hidden');
                    if (mapWrap) mapWrap.classList.add('is-hidden');
                    if (profileWrap) profileWrap.classList.remove('is-hidden');
                    return;
                }
                if (profileWrap) profileWrap.classList.add('is-hidden');
                if (useMap) {
                    if (frame) frame.src = '';
                    if (frameWrap) frameWrap.classList.add('is-hidden');
                    if (mapWrap) mapWrap.classList.remove('is-hidden');
                    return;
                }
                if (mapWrap) mapWrap.classList.add('is-hidden');
                if (frameWrap) frameWrap.classList.remove('is-hidden');
                if (frame) frame.src = href || '';
            };

            const normalize = function (value) {
                return String(value || '')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase();
            };
            const cargoImageMap = {
                'diretor-geral': 'diretor.png',
                'superintendente': 'superintendente.png',
                'coordenador': 'coordenador.png',
                'chefe de divisao': 'chefededivisao.png',
                'chefe de servico': 'chefedeservico.png',
                'chefe de nucleo': 'chefedenucleo.png',
                'agente de classe especial': 'classeespecial.png',
                'agente de primeira classe': 'primeiraclasse.png',
                'agente de segunda classe': 'segundaclasse.png',
                'agente de terceira classe': 'terceiraclasse.png',
                'agente aluno': 'aluno.png'
            };
            const setCargoImage = function (cargoValue, node) {
                if (!node) return;
                const key = normalize(cargoValue).trim();
                const file = cargoImageMap[key];
                if (!file) {
                    node.classList.add('is-hidden');
                    node.removeAttribute('src');
                    node.alt = '';
                    return;
                }
                node.src = 'assets/img/' + file;
                node.alt = cargoValue ? ('Imagem do cargo: ' + cargoValue) : 'Imagem do cargo';
                node.classList.remove('is-hidden');
            };

            const setEditFeedback = function (msg, isError) {
                const node = byId('profile-popup-edit-feedback');
                if (!node) return;
                node.textContent = msg || '';
                node.className = isError ? 'approvals-status is-error' : 'approvals-status';
            };

            const bindProfileEdit = function () {
                if (editBound) return;
                const trigger = byId('profile-popup-edit-trigger');
                const panel = byId('profile-popup-edit-panel');
                const fotoBtn = byId('profile-popup-edit-photo');
                const fileInput = byId('profile-popup-edit-file');
                const saveBtn = byId('profile-popup-save');
                if (!trigger || !panel || !fileInput || !saveBtn) return;

                trigger.addEventListener('click', function () {
                    if (panel.classList.contains('is-collapsed')) {
                        panel.classList.remove('is-collapsed');
                        requestAnimationFrame(function () {
                            panel.classList.add('is-open');
                        });
                    } else {
                        panel.classList.remove('is-open');
                        panel.addEventListener('transitionend', function handleCollapse() {
                            panel.classList.add('is-collapsed');
                            panel.removeEventListener('transitionend', handleCollapse);
                        });
                    }
                });

                if (fotoBtn) {
                    fotoBtn.addEventListener('click', function () {
                        fileInput.click();
                    });
                }

                fileInput.addEventListener('change', function () {
                    const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
                    if (!file) return;
                    if (!/^image\//i.test(file.type)) {
                        setEditFeedback('Selecione um arquivo de imagem válido.', true);
                        return;
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        setEditFeedback('A imagem deve ter no máximo 5MB.', true);
                        return;
                    }
                    pendingPhotoFile = file;
                    const photoNode = byId('profile-popup-photo');
                    if (photoNode) photoNode.src = URL.createObjectURL(file);
                    setEditFeedback('Foto carregada. Clique em "Salvar" para aplicar.');
                });

                saveBtn.addEventListener('click', async function () {
                    if (!editClient || !editUser) return;
                    const nomeInput = byId('profile-popup-edit-nome');
                    const rgInput = byId('profile-popup-edit-rg');
                    const nome = nomeInput && nomeInput.value ? nomeInput.value.trim() : '';
                    const rg = rgInput && rgInput.value ? rgInput.value.trim() : '';
                    if (!nome || !rg) {
                        setEditFeedback('Preencha nome e RG para salvar.', true);
                        return;
                    }

                    saveBtn.disabled = true;
                    try {
                        const basicResult = await editClient.rpc('update_own_profile_basic', {
                            p_nome_guerra: nome,
                            p_rg: rg
                        });
                        if (basicResult.error) {
                            setEditFeedback('Falha ao salvar nome/RG: ' + basicResult.error.message, true);
                            return;
                        }

                        if (pendingPhotoFile) {
                            const safeName = (pendingPhotoFile.name || 'foto')
                                .normalize('NFD')
                                .replace(/[\u0300-\u036f]/g, '')
                                .replace(/[^a-zA-Z0-9._-]/g, '_');
                            const ext = safeName.includes('.') ? safeName.split('.').pop().toLowerCase() : 'jpg';
                            const path = editUser.id + '/' + Date.now() + '_' + Math.random().toString(36).slice(2, 8) + '.' + ext;

                            const upload = await editClient
                                .storage
                                .from('profile-photos')
                                .upload(path, pendingPhotoFile, {
                                    cacheControl: '3600',
                                    upsert: false
                                });

                            if (upload.error) {
                                setEditFeedback('Nome/RG salvos, mas falha ao enviar foto: ' + upload.error.message, true);
                                return;
                            }

                            const publicUrlResult = editClient
                                .storage
                                .from('profile-photos')
                                .getPublicUrl(path);
                            const publicUrl = publicUrlResult && publicUrlResult.data ? publicUrlResult.data.publicUrl : '';

                            const result = await editClient.rpc('update_own_profile_photo', {
                                p_foto_url: publicUrl,
                                p_foto_path: path
                            });
                            if (result.error) {
                                setEditFeedback('Nome/RG salvos, mas falha ao salvar foto: ' + result.error.message, true);
                                return;
                            }

                            if (currentFotoPath && currentFotoPath !== path) {
                                await editClient.storage.from('profile-photos').remove([currentFotoPath]);
                            }

                            currentFotoPath = path;
                            pendingPhotoFile = null;
                        }

                        if (editProfile) {
                            editProfile.nome_guerra = nome;
                            editProfile.rg = rg;
                        }
                        const nameNode = byId('profile-popup-name');
                        const rgNode = byId('profile-popup-rg');
                        if (nameNode) nameNode.textContent = nome;
                        if (rgNode) rgNode.textContent = rg ? ('RG: ' + rg) : 'RG: -';
                        setEditFeedback('Perfil atualizado com sucesso.');
                    } catch (e) {
                        setEditFeedback('Falha ao salvar perfil.', true);
                    } finally {
                        saveBtn.disabled = false;
                    }
                });

                editBound = true;
            };

            const buildTokens = function (profile, user) {
                const raw = [
                    profile && profile.nome_guerra ? profile.nome_guerra : '',
                    profile && profile.rg ? profile.rg : '',
                    user && user.email ? user.email : ''
                ];
                const tokens = raw.map(normalize).filter(function (v) { return v.length >= 3; });
                const nomeParts = String(profile && profile.nome_guerra ? profile.nome_guerra : '')
                    .split(' ')
                    .map(function (v) { return normalize(v); })
                    .filter(function (v) { return v.length >= 4; });
                return Array.from(new Set(tokens.concat(nomeParts)));
            };

            const hasMention = function (row, tokens, userId) {
                if (!row || !tokens.length) return false;
                if (row.user_id && String(row.user_id) === String(userId)) return false;
                const source = normalize([
                    row.conteudo_completo,
                    row.texto,
                    row.observacoes,
                    row.relato,
                    row.detalhes,
                    row.resumo,
                    row.titulo,
                    row.subtitulo,
                    row.infrator,
                    row.numero_ait
                ].join(' '));
                return tokens.some(function (token) { return source.includes(token); });
            };

            const loadProfilePopup = async function () {
                if (!profileWrap) return;
                try {
                    if (!window.supabase || !window.supabase.createClient) return;
                    const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                    const sessionResult = await client.auth.getSession();
                    const session = sessionResult && sessionResult.data ? sessionResult.data.session : null;
                    const user = session ? session.user : null;
                    if (!user) return;

                    let profile = window.__painelProfile || null;
                    if (!profile) {
                        const profileResult = await client
                            .from('profiles')
                            .select('nome_guerra, rg, cargo, grupamento, cursos, foto_url, foto_path')
                            .eq('id', user.id)
                            .maybeSingle();
                        profile = profileResult && profileResult.data ? profileResult.data : {};
                    }

                    editClient = client;
                    editUser = user;
                    editProfile = profile;

                    const nameNode = byId('profile-popup-name');
                    const cargoNode = byId('profile-popup-cargo');
                    const cargoImgNode = byId('profile-popup-cargo-img');
                    const rgNode = byId('profile-popup-rg');
                    const photoNode = byId('profile-popup-photo');
                    if (nameNode) nameNode.textContent = profile.nome_guerra || user.email || 'Usuário';
                    if (cargoNode) cargoNode.textContent = profile.cargo || 'Cargo';
                    setCargoImage(profile.cargo, cargoImgNode);
                    if (rgNode) rgNode.textContent = profile.rg ? ('RG: ' + profile.rg) : 'RG: -';
                    if (photoNode && profile.foto_url) photoNode.src = profile.foto_url;
                    currentFotoPath = profile.foto_path || '';

                    const editNome = byId('profile-popup-edit-nome');
                    const editRg = byId('profile-popup-edit-rg');
                    if (editNome) editNome.value = profile.nome_guerra || '';
                    if (editRg) editRg.value = profile.rg || '';
                    bindProfileEdit();

                    const grupos = String(profile.grupamento || '').split(' || ').map(function (v) { return v.trim(); }).filter(Boolean);
                    const gruposNode = byId('profile-popup-grupos');
                    if (gruposNode) {
                        if (!grupos.length) {
                            gruposNode.innerHTML = '<span class="profile-course-empty">A definir</span>';
                        } else {
                            gruposNode.innerHTML = grupos.map(function (g, idx) {
                                const palette = ['#1d4ed8', '#0ea5e9', '#16a34a', '#f59e0b', '#ef4444'][idx % 5];
                                return '<span class="profile-course-chip" style="background:' + palette + '22;color:' + palette + ';">' + g + '</span>';
                            }).join('');
                        }
                    }

                    const cursosNode = byId('profile-popup-cursos');
                    if (cursosNode) {
                        const rawCourses = String(profile.cursos || '').trim();
                        if (!rawCourses) {
                            cursosNode.innerHTML = '<span class="profile-course-empty">A definir</span>';
                        } else {
                            const courses = rawCourses.split(' || ').map(function (s) { return s.trim(); }).filter(Boolean);
                            const courseColors = {
                                CFP: { bg: '#1d4ed8', fg: '#ffffff' },
                                CAFIT: { bg: '#0f766e', fg: '#ffffff' },
                                CVP: { bg: '#9333ea', fg: '#ffffff' },
                                OP: { bg: '#f59e0b', fg: '#111827' },
                                CDP: { bg: '#0f172a', fg: '#ffffff' },
                                CAD: { bg: '#ef4444', fg: '#ffffff' },
                                COEsp: { bg: '#16a34a', fg: '#ffffff' },
                                CFMB: { bg: '#0ea5e9', fg: '#ffffff' },
                                CFMT: { bg: '#2563eb', fg: '#ffffff' },
                                CDT: { bg: '#84d8a7', fg: '#0f172a' },
                                CDD: { bg: '#9b59b6', fg: '#ffffff' },
                                COA: { bg: '#0891b2', fg: '#ffffff' },
                                CPPAR: { bg: '#6d28d9', fg: '#ffffff' },
                                ARP: { bg: '#0f766e', fg: '#ffffff' }
                            };
                            cursosNode.innerHTML = courses.map(function (course) {
                                const code = course.split('|')[0].trim();
                                const palette = courseColors[code] || { bg: '#334155', fg: '#ffffff' };
                                return '<span class="profile-course-chip" style="background:' + palette.bg + 'E6;color:' + palette.fg + ';">' + course + '</span>';
                            }).join('');
                        }
                    }

                    const medalNode = byId('profile-popup-medals');
                    if (medalNode) {
                        const resolveMedalImage = function (value) {
                            const raw = String(value || '').trim();
                            if (!raw) return 'assets/img/mencaoelogio.png';
                            const lower = raw.toLowerCase();
                            if (lower.startsWith('http://') || lower.startsWith('https://')) return raw;
                            if (raw.startsWith('/') || raw.startsWith('assets/')) return raw;
                            return 'assets/img/' + raw;
                        };
                        const medalConfig = {
                            elogio_ref: { name: 'Referência elogiosa', image: 'mencaoelogio.png' },
                            elogio: { name: 'Elogio', image: 'mencaoelogio.png' },
                            merito: { name: 'Medalha ao Mérito', image: 'medalhamerito.png' },
                            bravura: { name: 'Medalha Bravura', image: 'medalhabravura.png' },
                            heroi_estradas: { name: 'Medalha Herói das Estradas', image: 'medalhaheroiestradas.png' },
                            washington: { name: 'Medalha Washington Luís', image: 'medalhawashington.png' },
                            antonio_felix_gracruza: { name: 'Medalha Antônio Félix Filho Grã-Cruz', image: 'medalhaantoniofelix.png' },
                            washington_gracruza: { name: 'Medalha Washington Luís Grã Cruz', image: 'medalhagracruzwashington.png' },
                            moeda_antonio_bronze: { name: 'Moeda Antônio Felix Bronze', image: 'moedaantoniofelixbronze.png' },
                            moeda_antonio_prata: { name: 'Moeda Antônio Felix Prata', image: 'moedaantoniofelixprata.png' },
                            moeda_antonio_ouro: { name: 'Moeda Antônio Felix Ouro', image: 'moedaantoniofelixouro.png' }
                        };

                        const medalResult = await client
                            .from('profile_medals')
                            .select('medal_code, medal_name, medal_image')
                            .eq('user_id', user.id)
                            .order('awarded_at', { ascending: false });

                        const medals = medalResult && Array.isArray(medalResult.data) ? medalResult.data : [];
                        if (!medals.length) {
                            medalNode.innerHTML = '<div class="profile-popup-empty">Nenhuma condecoração atribuída.</div>';
                        } else {
                            medalNode.innerHTML = medals.map(function (m) {
                                const conf = medalConfig[m.medal_code] || {};
                                const name = m.medal_name || conf.name || 'Condecoração';
                                const image = m.medal_image || conf.image || 'mencaoelogio.png';
                                const src = resolveMedalImage(image);
                                return (
                                    '<div class="profile-popup-medal">' +
                                    '<img src="' + src + '" alt="' + name + '" onerror="this.src=\'assets/img/mencaoelogio.png\'">' +
                                    '<span>' + name + '</span>' +
                                    '</div>'
                                );
                            }).join('');
                        }
                    }

                    const tokens = buildTokens(profile || {}, user);
                    const countOwn = async function (table) {
                        const q = await client.from(table).select('id', { count: 'exact', head: true }).eq('user_id', user.id);
                        return q && typeof q.count === 'number' ? q.count : 0;
                    };
                    const countMentioned = async function (table) {
                        const q = await client.from(table).select('*').limit(200);
                        if (q.error || !Array.isArray(q.data)) return 0;
                        const matched = q.data.filter(function (row) { return hasMention(row, tokens, user.id); });
                        return matched.length;
                    };
                    const countOwnFromTables = async function (tables) {
                        let sum = 0;
                        for (let i = 0; i < tables.length; i += 1) {
                            sum += await countOwn(tables[i]);
                        }
                        return sum;
                    };
                    const countMentionedFromTables = async function (tables) {
                        let sum = 0;
                        for (let i = 0; i < tables.length; i += 1) {
                            sum += await countMentioned(tables[i]);
                        }
                        return sum;
                    };

                    const [bouMade, bouCited, aitMade, aitCited, ripatMade, ripatCited] = await Promise.all([
                        countOwn('bous'),
                        countMentioned('bous'),
                        countOwn('aits'),
                        countMentioned('aits'),
                        countOwnFromTables(['patrulhas', 'relatorios_patrulha']),
                        countMentionedFromTables(['patrulhas', 'relatorios_patrulha'])
                    ]);

                    const setCount = function (id, value) {
                        const node = byId(id);
                        if (node) node.textContent = String(value || 0);
                    };
                    setCount('profile-popup-bou-total', (bouMade + bouCited));
                    setCount('profile-popup-ait-total', (aitMade + aitCited));
                    setCount('profile-popup-ripat-total', (ripatMade + ripatCited));
                } catch (e) {
                    /* ignore */
                }
            };

            const openPopup = function (event, sourceNode) {
                if (event) event.preventDefault();
                if (panel.classList.contains('is-open') && activeTrigger && sourceNode === activeTrigger) {
                    closePopup();
                    return;
                }
                syncAviso();
                const href = sourceNode ? sourceNode.getAttribute('href') : '';
                const labelNode = sourceNode ? sourceNode.querySelector('span') : null;
                const label = labelNode ? labelNode.textContent.trim() : 'Documento Interno';
                const useMap = sourceNode === openMap;
                const useProfile = sourceNode === openProfile;
                setDocInFrame(href, label, useMap, useProfile);
                if (useProfile) loadProfilePopup();
                activeTrigger = sourceNode || null;
                setActiveTriggerVisual(activeTrigger);
                mainDefault.classList.add('is-hidden');
                panel.classList.remove('is-hidden');
                requestAnimationFrame(function () {
                    panel.classList.add('is-open');
                    panel.setAttribute('aria-hidden', 'false');
                    if (useMap && window.__mapaInterativoRefresh) {
                        setTimeout(function () { window.__mapaInterativoRefresh(); }, 120);
                    }
                });
            };

            const closePopup = function () {
                panel.classList.remove('is-open');
                panel.setAttribute('aria-hidden', 'true');
                if (mainContent) mainContent.classList.remove('is-profile-open');
                setTimeout(function () {
                    panel.classList.add('is-hidden');
                    mainDefault.classList.remove('is-hidden');
                    activeTrigger = null;
                    setActiveTriggerVisual(null);
                }, 230);
            };

            openReg.addEventListener('click', function (event) {
                openPopup(event, openReg);
            });
            if (openCtb) {
                openCtb.addEventListener('click', function (event) {
                    openPopup(event, openCtb);
                });
            }
            openUni.addEventListener('click', function (event) {
                openPopup(event, openUni);
            });
            if (openMap) {
                openMap.addEventListener('click', function (event) {
                    openPopup(event, openMap);
                });
            }
            if (openProfile) {
                openProfile.addEventListener('click', function (event) {
                    openPopup(event, openProfile);
                });
            }
            if (headerEditProfile) {
                headerEditProfile.addEventListener('click', function (event) {
                    openPopup(event, openProfile || headerEditProfile);
                });
            }
            if (brandEditProfile) {
                brandEditProfile.addEventListener('click', function (event) {
                    openPopup(event, openProfile || brandEditProfile);
                });
            }
            if (closeBtn) closeBtn.addEventListener('click', closePopup);

            const openProfileFromHash = function () {
                if (window.location.hash === '#meu-perfil' && openProfile) {
                    openPopup(null, openProfile);
                }
            };

            window.addEventListener('hashchange', openProfileFromHash);
            openProfileFromHash();

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && panel.classList.contains('is-open')) {
                    closePopup();
                }
            });
        })();
    </script>
    <script>
        (async function loadPainelProfile() {
            try {
                if (!window.supabase || !window.supabase.createClient) return;
                const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                const sessionResult = await client.auth.getSession();
                const session = sessionResult && sessionResult.data ? sessionResult.data.session : null;
                const user = session ? session.user : null;
                if (!user) return;

                const result = await client
                    .from('profiles')
                    .select('nome_guerra, email, rg, cargo, grupamento, acesso, cursos, foto_url, is_admin')
                    .eq('id', user.id)
                    .maybeSingle();

                if (result.error || !result.data) return;
                const p = result.data;
                window.__painelProfile = p;
                window.__painelIsAdmin = p.is_admin === true;

                const nameNode = document.getElementById('painel-profile-name');
                const rgNode = document.getElementById('painel-profile-rg');
                const cargoNode = document.getElementById('painel-profile-cargo');
                const cargoImgNode = document.getElementById('painel-profile-cargo-img');
                const grupamentoNode = document.getElementById('painel-profile-grupamento');
                const imgNode = document.getElementById('painel-profile-photo');
                const medalsNode = document.getElementById('painel-profile-medals');
                const relatorioAlunoCard = document.getElementById('relatorio-aluno-card');
                const aceResultadosCard = document.getElementById('ace-resultados-card');
                const relatorioVooCard = document.getElementById('relatorio-voo-card');
                const painelDgpCard = document.getElementById('painel-dgp-card');

                const cursosNode = document.getElementById('painel-profile-cursos');
                const backgrounds = ['assets/img/fundo_1.png', 'assets/img/fundo_2.png'];
                const selectedBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
                const cardNode = document.getElementById('painel-profile-card');
                const courseColors = {
                    'CFP': { bg: '#1e3a8a', fg: '#ffffff' },
                    'CAFIT': { bg: '#facc15', fg: '#334155' },
                    'CVP': { bg: '#f9a8d4', fg: '#334155' },
                    'OP': { bg: '#7f1d1d', fg: '#ffffff' },
                    'CDP': { bg: '#64748b', fg: '#334155' },
                    'CAD': { bg: '#374151', fg: '#ffffff' },
                    'COEsp': { bg: '#111111', fg: '#ffffff' },
                    'CFMB': { bg: '#d97706', fg: '#334155' },
                    'CFMT': { bg: '#f4b183', fg: '#334155' },
                    'CDT': { bg: '#84d8a7', fg: '#0f172a' },
                    'CDD': { bg: '#9b59b6', fg: '#ffffff' },
                    'COA': { bg: '#166534', fg: '#ffffff' },
                    'CPPAR': { bg: '#556b2f', fg: '#ffffff' },
                    'ARP': { bg: '#e5d3b3', fg: '#334155' }
                };
                const setLockedCard = (cardEl, locked, message) => {
                    if (!cardEl) return;
                    if (locked) {
                        cardEl.classList.add('docs-card--locked');
                        cardEl.setAttribute('aria-disabled', 'true');
                        cardEl.setAttribute('tabindex', '-1');
                        cardEl.setAttribute('data-lock-message', message || 'Seção indisponível para este perfil');
                        return;
                    }
                    cardEl.classList.remove('docs-card--locked');
                    cardEl.removeAttribute('aria-disabled');
                    cardEl.removeAttribute('tabindex');
                    cardEl.removeAttribute('data-lock-message');
                };
                const normalizeText = (value) => String(value || '')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase()
                    .trim();
                const cargoImageMap = {
                    'diretor-geral': 'diretor.png',
                    'superintendente': 'superintendente.png',
                    'coordenador': 'coordenador.png',
                    'chefe de divisao': 'chefededivisao.png',
                    'chefe de servico': 'chefedeservico.png',
                    'chefe de nucleo': 'chefedenucleo.png',
                    'agente de classe especial': 'classeespecial.png',
                    'agente de primeira classe': 'primeiraclasse.png',
                    'agente de segunda classe': 'segundaclasse.png',
                    'agente de terceira classe': 'terceiraclasse.png',
                    'agente aluno': 'aluno.png'
                };
                const setCargoImage = (cargoValue, node) => {
                    if (!node) return;
                    const key = normalizeText(cargoValue);
                    const file = cargoImageMap[key];
                    if (!file) {
                        node.classList.add('is-hidden');
                        node.removeAttribute('src');
                        node.alt = '';
                        return;
                    }
                    node.src = 'assets/img/' + file;
                    node.alt = cargoValue ? ('Imagem do cargo: ' + cargoValue) : 'Imagem do cargo';
                    node.classList.remove('is-hidden');
                };
                const resolveMedalImage = (value) => {
                    const raw = String(value || '').trim();
                    if (!raw) return 'assets/img/mencaoelogio.png';
                    const lower = raw.toLowerCase();
                    if (lower.startsWith('http://') || lower.startsWith('https://')) return raw;
                    if (raw.startsWith('/') || raw.startsWith('assets/')) return raw;
                    return 'assets/img/' + raw;
                };

                if (cardNode) cardNode.style.backgroundImage = `url('${selectedBg}')`;
                if (nameNode) nameNode.textContent = p.nome_guerra || p.email || user.email || 'Usuário';
                if (rgNode) rgNode.textContent = `RG: ${p.rg || '-'}`;
                if (cargoNode) cargoNode.textContent = p.cargo || 'Cargo do agente';
                setCargoImage(p.cargo, cargoImgNode);
                if (imgNode && p.foto_url) imgNode.src = p.foto_url;

                try {
                    const isAgenteAluno = String(p.cargo || '').trim().toLowerCase() === 'agente aluno';
                    const isAdmin = p.is_admin === true;
                    const grupos = String(p.grupamento || '').split(' || ').map(v => v.trim()).filter(Boolean);
                    const isDoa = grupos.some(g => normalizeText(g) === normalizeText('Divisão de Operações Aéreas'));
                    const isDgp = grupos.some(g => normalizeText(g) === normalizeText('Diretoria de Gestão de Pessoas'));
                    const hasAcesso = normalizeText(p.acesso || '').includes('acesso');
                    setLockedCard(relatorioAlunoCard, isAgenteAluno, 'Indisponível para Agente Aluno');
                    setLockedCard(aceResultadosCard, !(isDgp || isAdmin || hasAcesso), 'Acesso restrito à DGP ou perfil com acesso');
                    setLockedCard(relatorioVooCard, !(isDoa || isAdmin), 'Acesso restrito à Divisão de Operações Aéreas');
                    setLockedCard(painelDgpCard, !isAdmin, 'Indisponível para este perfil');
                    if (grupamentoNode) grupamentoNode.textContent = grupos.length ? grupos.join(' | ') : '-';
                    if (cursosNode) {
                        const rawCourses = String(p.cursos || '').trim();
                        if (!rawCourses) {
                            cursosNode.innerHTML = '<span class="profile-course-empty">A definir</span>';
                        } else {
                            const courses = rawCourses.split(' || ').map((s) => s.trim()).filter(Boolean);
                            cursosNode.innerHTML = courses.map((course) => {
                                const code = course.split('|')[0].trim();
                                const palette = courseColors[code] || { bg: '#334155', fg: '#ffffff' };
                                return `<span class="profile-course-chip" style="background:${palette.bg}E6;color:${palette.fg};">${course}</span>`;
                            }).join('');
                        }
                    }
                } catch (e) {
                    /* keep basic profile info */
                }

                if (medalsNode) {
                    try {
                        const medalResult = await client
                            .from('profile_medals')
                            .select('medal_image, medal_name')
                            .eq('user_id', user.id)
                            .order('awarded_at', { ascending: false })
                            .limit(24);
                        const medals = medalResult && Array.isArray(medalResult.data) ? medalResult.data : [];
                        if (medals.length) {
                            medalsNode.innerHTML = medals.map(function (medal) {
                                const src = resolveMedalImage(medal.medal_image);
                                const alt = medal.medal_name ? String(medal.medal_name) : 'Condecoração do usuário';
                                return '<img src="' + src + '" alt="' + alt + '" class="profile-brand-medal" onerror="this.src=\'assets/img/mencaoelogio.png\'">';
                            }).join('');
                            medalsNode.classList.remove('is-hidden');
                        } else {
                            medalsNode.classList.add('is-hidden');
                        }
                    } catch (e) {
                        medalsNode.classList.add('is-hidden');
                    }
                }
            } catch (e) {
                /* ignore */
            }
        })();
    </script>
    <script>
        (async function loadPainelLatestAviso() {
            try {
                if (!window.supabase || !window.supabase.createClient) return;
                const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                const box = document.getElementById('painel-latest-aviso');
                if (!box) return;
                const esc = function (value) {
                    if (value === null || value === undefined) return '';
                    return String(value)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                };

                const result = await client
                    .from('avisos')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (result.error) {
                    box.innerHTML = '<h3>Mural de avisos</h3><p class="painel-latest-aviso-empty">Não foi possível carregar os avisos.</p>';
                    return;
                }

                const aviso = Array.isArray(result.data) && result.data.length ? result.data[0] : null;
                if (!aviso) {
                    box.innerHTML = '<h3>Mural de avisos</h3><p class="painel-latest-aviso-empty">Nenhum aviso publicado até o momento.</p>';
                    return;
                }

                const titulo = esc(aviso.titulo || 'Aviso interno');
                const subtitulo = esc(aviso.subtitulo || '');
                const texto = esc(aviso.texto || '');
                const midia = aviso.midia_url || '';
                const createdAt = aviso.created_at ? new Date(aviso.created_at).toLocaleString('pt-BR') : '';
                const mediaHtml = midia
                    ? '<div class="painel-aviso-media-wrap"><img src="' + esc(midia) + '" alt="Mídia do aviso" class="painel-aviso-media"></div>'
                    : '';

                box.innerHTML =
                    '<h3>Mural de avisos</h3>' +
                    '<div class="painel-aviso-layout">' +
                    '<div class="painel-aviso-copy">' +
                    '<h4>' + titulo + '</h4>' +
                    (subtitulo ? '<p class="painel-aviso-subtitulo">' + subtitulo + '</p>' : '') +
                    (texto ? '<p class="painel-aviso-texto">' + texto.replace(/\n/g, '<br>') + '</p>' : '') +
                    (createdAt ? '<span class="painel-aviso-data">Publicado em ' + esc(createdAt) + '</span>' : '') +
                    '<a href="/interno/avisos.html" class="painel-aviso-link">Ver todos os avisos</a>' +
                    '</div>' +
                    mediaHtml +
                    '</div>';
            } catch (e) {
                const box = document.getElementById('painel-latest-aviso');
                if (box) {
                    box.innerHTML = '<h3>Mural de avisos/h3><p class="painel-latest-aviso-empty">Erro ao carregar avisos.</p>';
                }
            }
        })();
    </script>
    <script>
        (async function loadPainelNotifications() {
            function byId(id) { return document.getElementById(id); }
            function esc(value) {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
            function normalize(value) {
                return String(value || '')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase();
            }
            function buildTokens(profile, user) {
                const raw = [
                    profile && profile.nome_guerra ? profile.nome_guerra : '',
                    profile && profile.rg ? profile.rg : '',
                    user && user.email ? user.email : ''
                ];
                const tokens = raw
                    .map(normalize)
                    .filter(function (v) { return v.length >= 3; });
                const nomeParts = String(profile && profile.nome_guerra ? profile.nome_guerra : '')
                    .split(' ')
                    .map(function (v) { return normalize(v); })
                    .filter(function (v) { return v.length >= 4; });
                return Array.from(new Set(tokens.concat(nomeParts)));
            }
            function hasMention(row, tokens, userId) {
                if (!row || !tokens.length) return false;
                if (row.user_id && String(row.user_id) === String(userId)) return false;
                const source = normalize([
                    row.conteudo_completo,
                    row.texto,
                    row.observacoes,
                    row.relato,
                    row.detalhes,
                    row.resumo,
                    row.titulo,
                    row.subtitulo,
                    row.infrator,
                    row.numero_ait
                ].join(' '));
                return tokens.some(function (token) { return source.includes(token); });
            }
            function getDateLabel(row) {
                const raw = row.created_at || row.data_criacao || row.data || '';
                if (!raw) return 'Data não informada';
                const d = new Date(raw);
                if (Number.isNaN(d.getTime())) return String(raw);
                return d.toLocaleString('pt-BR');
            }
            function storageKeyForUser(userId) {
                return 'painel_notificacoes_dismissed_' + String(userId || '');
            }
            function loadDismissed(userId) {
                try {
                    const raw = localStorage.getItem(storageKeyForUser(userId));
                    const parsed = raw ? JSON.parse(raw) : [];
                    return Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    return [];
                }
            }
            function saveDismissed(userId, keys) {
                try {
                    localStorage.setItem(storageKeyForUser(userId), JSON.stringify(Array.from(new Set(keys))));
                } catch (e) {
                    /* ignore */
                }
            }
            function toNotification(type, row, options) {
                const id = row && row.id ? String(row.id) : Math.random().toString(36).slice(2);
                const title = type === 'bou'
                    ? (row.titulo || 'Cita\u00e7\u00e3o em BOU')
                    : type === 'ait'
                        ? ('Cita\u00e7\u00e3o em AIT ' + (row.numero_ait || ('#' + id)))
                        : type === 'patrulha'
                            ? (row.titulo || row.area || 'Cita\u00e7\u00e3o em relat\u00f3rio de patrulha')
                            : type === 'diario'
                                ? ('Cita\u00e7\u00e3o no Di\u00e1rio Oficial #' + (row.numero_decreto || id))
                                : type === 'corregedoria'
                                    ? ('Cita\u00e7\u00e3o na Corregedoria ' + (row.numero || row.title || ('#' + id)))
                                : (row.titulo || 'Cita\u00e7\u00e3o em relat\u00f3rio aluno');
                return {
                    key: type + ':' + id,
                    type: type,
                    title: title,
                    when: getDateLabel(row),
                    href: options.href,
                    clickable: options.clickable,
                    blockedText: options.blockedText || ''
                };
            }
            async function fetchFromTables(client, tables, tokens, userId, options) {
                for (let i = 0; i < tables.length; i += 1) {
                    const table = tables[i];
                    const query = await client.from(table).select('*').limit(200);
                    if (query.error) continue;
                    return (query.data || [])
                        .filter(function (row) { return hasMention(row, tokens, userId); })
                        .map(function (row) { return toNotification(options.type, row, options); });
                }
                return [];
            }

            async function fetchCorregedoria(client, userId) {
                const query = await client
                    .from('corregedoria_posts')
                    .select('id,title,numero,created_at,mentioned_user_ids')
                    .order('created_at', { ascending: false })
                    .limit(200);
                if (query.error) return [];
                return (query.data || [])
                    .filter(function (row) {
                        const list = Array.isArray(row.mentioned_user_ids) ? row.mentioned_user_ids : [];
                        return list.map(String).includes(String(userId));
                    })
                    .map(function (row) {
                        return toNotification('corregedoria', row, {
                            type: 'corregedoria',
                            href: '/interno/corregedoria.html',
                            clickable: true
                        });
                    });
            }

            try {
                if (!window.supabase || !window.supabase.createClient) return;
                const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                const sessionResult = await client.auth.getSession();
                const session = sessionResult && sessionResult.data ? sessionResult.data.session : null;
                const user = session ? session.user : null;
                if (!user) return;

                let profile = window.__painelProfile || null;
                if (!profile) {
                    const profileResult = await client
                        .from('profiles')
                        .select('nome_guerra, rg, cargo')
                        .eq('id', user.id)
                        .maybeSingle();
                    profile = profileResult && profileResult.data ? profileResult.data : {};
                }
                const cargo = String(profile && profile.cargo ? profile.cargo : '').trim().toLowerCase();
                const isAgenteAluno = cargo === 'agente aluno';
                const tokens = buildTokens(profile || {}, user);

                const all = [];
                const bou = await fetchFromTables(client, ['bous'], tokens, user.id, {
                    type: 'bou',
                    href: '/interno/bou-envios.html',
                    clickable: true
                });
                const ait = await fetchFromTables(client, ['aits'], tokens, user.id, {
                    type: 'ait',
                    href: '/interno/ait.html',
                    clickable: true
                });
                const patrulha = await fetchFromTables(client, ['patrulhas', 'relatorios_patrulha'], tokens, user.id, {
                    type: 'patrulha',
                    href: '/interno/patrulha.html',
                    clickable: true
                });
                const aluno = await fetchFromTables(client, ['relatorios_aluno', 'relatorio_aluno'], tokens, user.id, {
                    type: 'aluno',
                    href: '/interno/relatorio-aluno.html',
                    clickable: !isAgenteAluno,
                    blockedText: 'Seu perfil não tem acesso ao Relatório aluno'
                });
                const diario = await fetchFromTables(client, ['diarios_oficiais'], tokens, user.id, {
                    type: 'diario',
                    href: '/interno/diario-oficial.html',
                    clickable: true
                });
                const corregedoria = await fetchCorregedoria(client, user.id);
                all.push.apply(all, bou);
                all.push.apply(all, ait);
                all.push.apply(all, patrulha);
                all.push.apply(all, aluno);
                all.push.apply(all, diario);
                all.push.apply(all, corregedoria);

                const unique = [];
                const seen = new Set();
                all.forEach(function (item) {
                    if (!seen.has(item.key)) {
                        seen.add(item.key);
                        unique.push(item);
                    }
                });

                const popup = byId('painel-notificacoes-popup');
                const list = byId('painel-notificacoes-list');
                const badge = byId('painel-notificacoes-badge');
                const miniBadge = byId('painel-notificacoes-mini-badge');
                const toggle = byId('painel-notificacoes-toggle');
                const miniBtn = byId('painel-notificacoes-mini');
                const closeBtn = byId('painel-notificacoes-close');
                const clearAllBtn = byId('painel-notificacoes-clear-all');
                let dismissedKeys = loadDismissed(user.id);

                if (!popup || !list) return;
                function renderNotificationList() {
                    const visible = unique.filter(function (n) {
                        return dismissedKeys.indexOf(n.key) === -1;
                    });
                    if (badge) {
                        badge.textContent = String(visible.length);
                        badge.classList.toggle('is-hidden', visible.length === 0);
                    }
                    if (miniBadge) miniBadge.textContent = String(visible.length);
                    if (!visible.length) {
                        popup.classList.add('is-hidden');
                        popup.classList.remove('is-minimized');
                        list.innerHTML = '<p class="painel-notificacoes-empty">Nenhuma citação encontrada no momento.</p>';
                        return;
                    }
                    popup.classList.remove('is-hidden');
                    popup.classList.add('is-minimized');
                    list.innerHTML = visible.map(function (item) {
                        const klass = item.clickable ? 'painel-notificacao-item' : 'painel-notificacao-item is-locked';
                        const extra = item.clickable ? '' : ('<span class="painel-notificacao-lock">' + esc(item.blockedText) + '</span>');
                        return '<div class="painel-notificacao-row" data-key="' + esc(item.key) + '">' +
                            '<a href="' + esc(item.href) + '" class="' + klass + '" data-clickable="' + (item.clickable ? '1' : '0') + '">' +
                                '<strong>' + esc(item.title) + '</strong>' +
                                '<span>' + esc(item.when) + '</span>' +
                                extra +
                            '</a>' +
                            '<button type="button" class="painel-notificacao-delete" title="Apagar notificação" aria-label="Apagar notificação">' +
                                '<i class="fas fa-trash-alt" aria-hidden="true"></i>' +
                            '</button>' +
                        '</div>';
                    }).join('');

                    list.querySelectorAll('.painel-notificacao-item[data-clickable="0"]').forEach(function (node) {
                        node.addEventListener('click', function (event) {
                            event.preventDefault();
                        });
                    });
                    list.querySelectorAll('.painel-notificacao-delete').forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            const row = btn.closest('.painel-notificacao-row');
                            if (!row) return;
                            const key = row.getAttribute('data-key');
                            if (!key) return;
                            dismissedKeys.push(key);
                            dismissedKeys = Array.from(new Set(dismissedKeys));
                            saveDismissed(user.id, dismissedKeys);
                            renderNotificationList();
                        });
                    });
                }
                renderNotificationList();

                if (toggle) {
                    toggle.addEventListener('click', function (event) {
                        event.preventDefault();
                        if (popup.classList.contains('is-hidden')) {
                            popup.classList.remove('is-hidden');
                            popup.classList.remove('is-minimized');
                            return;
                        }
                        if (popup.classList.contains('is-minimized')) {
                            popup.classList.remove('is-minimized');
                            return;
                        }
                        popup.classList.add('is-minimized');
                    });
                }
                if (miniBtn) {
                    miniBtn.addEventListener('click', function () {
                        if (popup.classList.contains('is-hidden')) {
                            popup.classList.remove('is-hidden');
                        }
                        popup.classList.remove('is-minimized');
                    });
                }
                if (closeBtn) {
                    closeBtn.addEventListener('click', function () {
                        if (popup.classList.contains('is-hidden')) return;
                        popup.classList.add('is-minimized');
                    });
                }
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', function () {
                        dismissedKeys = unique.map(function (n) { return n.key; });
                        saveDismissed(user.id, dismissedKeys);
                        renderNotificationList();
                    });
                }

                if (unique.length > 0) {
                    popup.classList.remove('is-hidden');
                    popup.classList.add('is-minimized');
                } else {
                    popup.classList.add('is-hidden');
                }
            } catch (e) {
                const list = document.getElementById('painel-notificacoes-list');
                if (list) {
                    list.innerHTML = '<p class="painel-notificacoes-empty">Não foi possível carregar as notificações.</p>';
                }
            }
        })();
    </script>
    <script>
        (async function setupPainelShiftButton() {
            function byId(id) { return document.getElementById(id); }
            const btn = byId('painel-shift-btn');
            if (!btn) return;

            const waitShiftControl = async () => {
                for (let i = 0; i < 40; i += 1) {
                    if (window.__shiftControl && typeof window.__shiftControl.toggle === 'function') {
                        return window.__shiftControl;
                    }
                    await new Promise((resolve) => setTimeout(resolve, 100));
                }
                return null;
            };

            const shiftControl = await waitShiftControl();
            if (!shiftControl) return;
            let showClosedState = false;

            const render = (state) => {
                const s = state || shiftControl.getState();
                btn.classList.remove('profile-shift-btn--idle', 'profile-shift-btn--active', 'profile-shift-btn--closed');

                if (s.status === 'active' && s.startAt) {
                    btn.classList.add('profile-shift-btn--active');
                    btn.textContent = 'Em serviço • ' + shiftControl.formatHms(Date.now() - Number(s.startAt));
                    return;
                }

                if (s.status === 'closed') {
                    if (!showClosedState) {
                        btn.classList.add('profile-shift-btn--idle');
                        btn.textContent = 'Entrar em serviço';
                        return;
                    }
                    btn.classList.add('profile-shift-btn--closed');
                    btn.textContent = s.totalMs
                        ? ('Serviço encerrado • ' + shiftControl.formatHms(s.totalMs))
                        : 'Serviço encerrado';
                    return;
                }

                btn.classList.add('profile-shift-btn--idle');
                btn.textContent = 'Entrar em serviço';
            };

            btn.addEventListener('click', async function () {
                const current = shiftControl.getState();
                showClosedState = current.status === 'active';
                await shiftControl.toggle();
            });

            shiftControl.subscribe((state) => render(state));
            setInterval(() => render(shiftControl.getState()), 1000);
            render(shiftControl.getState());
        })();
    </script>
    <script>
        (function setupOnDutyList() {
            function byId(id) { return document.getElementById(id); }
            const listNode = byId('painel-on-duty-list');
            const countNode = byId('painel-on-duty-count');
            if (!listNode) return;

            if (!window.supabase || !window.supabase.createClient) return;
            const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

            let refreshTimer = null;
            let busy = false;

            const safe = function (v, fallback) {
                const s = (v || '').toString().trim();
                return s || (fallback || '-');
            };

            const render = function (items) {
                const total = items.length;
                if (countNode) countNode.textContent = String(total);
                if (!total) {
                    listNode.innerHTML = '<p class="painel-on-duty-empty">Nenhum agente em serviço.</p>';
                    return;
                }
                listNode.innerHTML = items.map(function (agent) {
                    const nome = safe(agent.nome_guerra, 'Agente');
                    const rg = safe(agent.rg, '-');
                    const cargo = safe(agent.cargo, 'Cargo não definido');
                    const grupamentoRaw = safe(agent.grupamento, 'Grupamento não definido');
                    const grupamento = grupamentoRaw.includes(' || ')
                        ? grupamentoRaw.split(' || ').map(function (g) { return g.trim(); }).filter(Boolean).join(' | ')
                        : grupamentoRaw;
                    const foto = safe(agent.foto_url, 'assets/img/prf.png');
                    return (
                        '<div class="painel-on-duty-item">' +
                        '<img src="' + foto + '" alt="' + nome + '" class="painel-on-duty-avatar" onerror="this.src=\'assets/img/prf.png\'">' +
                        '<div>' +
                        '<div class="painel-on-duty-name">' + nome + '</div>' +
                        '<div class="painel-on-duty-meta">RG: ' + rg + ' • ' + cargo + '</div>' +
                        '<div class="painel-on-duty-grupo">' + grupamento + '</div>' +
                        '</div>' +
                        '</div>'
                    );
                }).join('');
            };

            const fetchList = async function () {
                if (busy) return;
                busy = true;
                try {
                    const active = await client
                        .from('agent_pontos')
                        .select('user_id,inicio_at')
                        .is('fim_at', null)
                        .order('inicio_at', { ascending: true });

                    if (active.error || !Array.isArray(active.data)) {
                        listNode.innerHTML = '<p class="painel-on-duty-empty">Não foi possível carregar.</p>';
                        if (countNode) countNode.textContent = '0';
                        return;
                    }

                    const orderedIds = [];
                    const seen = new Set();
                    active.data.forEach(function (row) {
                        const id = row && row.user_id ? String(row.user_id) : '';
                        if (!id || seen.has(id)) return;
                        seen.add(id);
                        orderedIds.push(id);
                    });

                    if (!orderedIds.length) {
                        render([]);
                        return;
                    }

                    const profiles = await client
                        .from('profiles')
                        .select('id,nome_guerra,rg,cargo,grupamento,foto_url')
                        .in('id', orderedIds);

                    const map = new Map();
                    if (profiles && Array.isArray(profiles.data)) {
                        profiles.data.forEach(function (p) {
                            if (p && p.id) map.set(String(p.id), p);
                        });
                    }

                    const items = orderedIds.map(function (id) { return map.get(id); }).filter(Boolean);
                    render(items);
                } catch (e) {
                    listNode.innerHTML = '<p class="painel-on-duty-empty">Não foi possível carregar.</p>';
                    if (countNode) countNode.textContent = '0';
                } finally {
                    busy = false;
                }
            };

            const scheduleRefresh = function () {
                if (refreshTimer) clearTimeout(refreshTimer);
                refreshTimer = setTimeout(fetchList, 300);
            };

            fetchList();
            try {
                client
                    .channel('agent_pontos_live')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'agent_pontos' }, scheduleRefresh)
                    .subscribe();
            } catch (e) {
                /* ignore */
            }

            window.addEventListener('shift-state-changed', scheduleRefresh);
        })();
    </script>
</body>
</html>
